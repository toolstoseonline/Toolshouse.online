<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Multi‚ÄëPage Scanner ¬∑ Camera to PDF</title>

<!-- jsPDF for multi‚Äëpage PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Tesseract OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: linear-gradient(145deg, #dbeafe 0%, #fef3c7 100%);
    min-height: 100vh;
    padding: 12px 12px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

header {
    text-align: center;
    padding: 16px 5px 8px;
    font-size: 2rem;
    font-weight: 700;
    color: #1e3a8a;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}

.badge {
    background: #2563eb;
    color: white;
    font-size: 0.8rem;
    padding: 4px 14px;
    border-radius: 40px;
    font-weight: 500;
}

.container {
    max-width: 700px;
    width: 100%;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(12px);
    padding: 22px 18px 28px;
    border-radius: 38px;
    box-shadow: 0 20px 40px rgba(0,20,50,0.25);
    border: 1px solid rgba(255,255,255,0.8);
}

/* source buttons */
.source-row {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.source-btn {
    flex: 1 1 140px;
    background: #ffffffdd;
    border: 1.5px solid #2563eb60;
    padding: 14px 10px;
    border-radius: 36px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e3a8a;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.05);
    transition: all 0.2s;
    cursor: pointer;
    backdrop-filter: blur(4px);
}

.source-btn:active { background: #2563eb20; }
.source-btn input { display: none; }

.upload-box {
    border: 2.5px dashed #2563eb;
    padding: 30px 15px;
    text-align: center;
    border-radius: 34px;
    cursor: pointer;
    background: #f9faff;
    font-size: 1.2rem;
    font-weight: 500;
    color: #1e40af;
    margin: 10px 0 15px;
    transition: background 0.2s;
}

.upload-box.highlight { background: #e6f0ff; }

/* camera preview + controls */
#cameraContainer {
    margin: 15px 0 10px;
    border-radius: 36px;
    overflow: hidden;
    box-shadow: 0 12px 28px rgba(0,0,0,0.3);
    display: none;
    background: #000;
    border: 3px solid white;
}

#cameraFeed {
    width: 100%;
    max-height: 340px;
    object-fit: cover;
    display: block;
}

.camera-actions {
    display: flex;
    gap: 12px;
    margin: 12px 0 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.camera-btn {
    background: #1e293b;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 14px 24px;
    font-weight: 600;
    font-size: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 10px #00000040;
    flex: 1 1 auto;
}

/* captured pages strip */
.pages-strip {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding: 10px 5px 15px;
    margin: 15px 0 5px;
    scrollbar-width: thin;
    white-space: nowrap;
}

.page-thumb {
    flex: 0 0 auto;
    width: 90px;
    height: 110px;
    border-radius: 20px;
    border: 3px solid white;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    background: #f1f5f9;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.1s;
}

.page-thumb:hover { transform: scale(1.02); }

/* main preview (selected image) */
#preview {
    max-width: 100%;
    max-height: 260px;
    margin: 8px 0 10px;
    border-radius: 28px;
    box-shadow: 0 12px 25px rgba(0,0,0,0.2);
    background: #f1f5f9;
    object-fit: contain;
    display: none;
    border: 3px solid white;
}

.action-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin: 15px 0 15px;
    justify-content: center;
}

.action-btn {
    flex: 1 1 130px;
    padding: 16px 8px;
    border: none;
    border-radius: 40px;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    box-shadow: 0 8px 16px rgba(0,40,80,0.2);
    transition: 0.1s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: white;
    color: #1e3a8a;
    border: 1px solid #a5b4fc;
}

.action-btn.primary { background: #2563eb; color: white; border: none; }
.action-btn.secondary { background: #059669; color: white; border: none; }
.action-btn.warning { background: #b45309; color: white; border: none; }

.action-btn:active { transform: scale(0.96); }

textarea {
    width: 100%;
    height: 140px;
    margin-top: 18px;
    padding: 18px;
    border-radius: 28px;
    border: 1.5px solid #cbd5e1;
    font-family: 'Segoe UI', monospace;
    font-size: 1rem;
    resize: vertical;
    background: white;
}

.ad-box {
    margin-top: 28px;
    padding: 16px 8px;
    text-align: center;
    background: #f8fafc;
    border-radius: 32px;
    color:#334155;
    font-weight: 500;
    border: 1px solid #e2e8f0;
    font-size: 1rem;
}

footer { margin-top: 16px; color: #334155; font-size: 0.85rem; }

@media (max-width: 500px) {
    .source-btn { flex: 1 1 120px; font-size: 0.95rem; }
    .action-btn { font-size: 0.95rem; padding: 14px 4px; }
}
</style>
</head>
<body>

<header>
    üì∏ Multi‚ÄëScan <span class="badge">multiple photos ‚Üí PDF</span>
</header>

<div class="container">

    <!-- source row: camera (live) / gallery / native camera -->
    <div class="source-row">
        <label class="source-btn" id="liveCamBtn">üé• Live camera
            <input type="file" id="cameraCapture" accept="image/*" capture="environment" hidden>
        </label>
        <label class="source-btn" id="galleryBtn">üñºÔ∏è Gallery
            <input type="file" id="galleryInput" accept="image/*" multiple hidden>
        </label>
    </div>

    <!-- drop zone -->
    <div class="upload-box" id="uploadBox">
        ‚¨ÜÔ∏è Tap or drop images (multiple allowed)
    </div>

    <!-- live camera preview -->
    <div id="cameraContainer">
        <video id="cameraFeed" autoplay playsinline></video>
        <div class="camera-actions">
            <button class="camera-btn" id="captureBtn">üì∏ Capture page</button>
            <button class="camera-btn" id="closeCamBtn">‚úñÔ∏è Close</button>
        </div>
    </div>

    <!-- thumbnail strip for captured pages -->
    <div class="pages-strip" id="pagesStrip"></div>

    <!-- selected image preview (full size) -->
    <img id="preview" alt="preview">

    <!-- action buttons -->
    <div class="action-grid">
        <button class="action-btn primary" id="pdfBtn">üì• PDF all</button>
        <button class="action-btn secondary" id="ocrBtn">üîç OCR this</button>
        <button class="action-btn" id="removeBtn">üóëÔ∏è Remove last</button>
        <button class="action-btn warning" id="clearBtn">üîÑ Clear all</button>
    </div>

    <!-- OCR text area -->
    <textarea id="ocrResult" placeholder="Extracted text from selected page ..." readonly></textarea>

    <!-- ad space -->
    <div class="ad-box">üì¢ Google AdSense ¬∑ 320x100</div>
</div>

<footer>‚ö° tap image in strip to select ¬∑ multiple pages in one PDF</footer>

<script>
(function() {
    // ----- DOM elements -----
    const liveCamBtn = document.getElementById('liveCamBtn');
    const cameraCapture = document.getElementById('cameraCapture');
    const galleryBtn = document.getElementById('galleryBtn');
    const galleryInput = document.getElementById('galleryInput');
    const uploadBox = document.getElementById('uploadBox');
    const cameraContainer = document.getElementById('cameraContainer');
    const cameraFeed = document.getElementById('cameraFeed');
    const captureBtn = document.getElementById('captureBtn');
    const closeCamBtn = document.getElementById('closeCamBtn');
    const preview = document.getElementById('preview');
    const pagesStrip = document.getElementById('pagesStrip');
    const pdfBtn = document.getElementById('pdfBtn');
    const ocrBtn = document.getElementById('ocrBtn');
    const removeBtn = document.getElementById('removeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const ocrResult = document.getElementById('ocrResult');

    // ----- state -----
    let capturedPages = [];            // array of { dataURL, timestamp }
    let selectedIndex = -1;            // index of page shown in preview
    let cameraStream = null;           // active camera stream

    // ----- helper: stop camera -----
    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        cameraContainer.style.display = 'none';
        cameraFeed.srcObject = null;
    }

    // ----- render thumbnail strip & update preview selection -----
    function renderStrip() {
        let html = '';
        capturedPages.forEach((page, idx) => {
            html += `<img src="${page.dataURL}" class="page-thumb" data-index="${idx}" title="Page ${idx+1}">`;
        });
        pagesStrip.innerHTML = html;

        // attach click event to each thumbnail
        document.querySelectorAll('.page-thumb').forEach(thumb => {
            thumb.addEventListener('click', (e) => {
                const index = parseInt(thumb.dataset.index, 10);
                selectPage(index);
            });
        });

        // if we have pages and no selected index, select first
        if (capturedPages.length > 0 && (selectedIndex < 0 || selectedIndex >= capturedPages.length)) {
            selectPage(0);
        } else if (capturedPages.length === 0) {
            preview.style.display = 'none';
            preview.src = '';
            selectedIndex = -1;
        } else if (selectedIndex >= 0 && selectedIndex < capturedPages.length) {
            // keep same selection, just update preview if needed (already consistent)
            preview.src = capturedPages[selectedIndex].dataURL;
            preview.style.display = 'block';
        }
    }

    // select a specific page by index
    function selectPage(index) {
        if (index >= 0 && index < capturedPages.length) {
            selectedIndex = index;
            preview.src = capturedPages[selectedIndex].dataURL;
            preview.style.display = 'block';
            // clear OCR when switching
            ocrResult.value = '';
        }
    }

    // add a new page (from dataURL)
    function addPage(dataURL) {
        capturedPages.push({ dataURL, timestamp: Date.now() });
        renderStrip();
        // auto-select the new page
        selectPage(capturedPages.length - 1);
    }

    // ----- handle files from gallery / drop (multiple) -----
    function handleFiles(files) {
        if (!files || files.length === 0) return;
        // convert FileList to array
        const fileArray = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (fileArray.length === 0) {
            alert('No valid images');
            return;
        }

        let loaded = 0;
        fileArray.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                addPage(e.target.result);
                loaded++;
            };
            reader.readAsDataURL(file);
        });
    }

    // ----- camera handling (live) -----
    async function startCamera() {
        try {
            stopCamera();
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            cameraStream = stream;
            cameraFeed.srcObject = stream;
            cameraContainer.style.display = 'block';
        } catch (err) {
            alert('Camera not available. Use gallery.');
        }
    }

    // capture from live feed
    function captureFromCamera() {
        if (!cameraStream) return;

        const canvas = document.createElement('canvas');
        const track = cameraStream.getVideoTracks()[0];
        const settings = track.getSettings();
        canvas.width = settings.width || 1280;
        canvas.height = settings.height || 720;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

        canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onload = (e) => addPage(e.target.result);
            reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.9);
    }

    // ----- event listeners -----
    // live camera button: open preview
    liveCamBtn.addEventListener('click', (e) => {
        e.preventDefault();
        startCamera();
    });

    // capture button inside camera
    captureBtn.addEventListener('click', captureFromCamera);
    closeCamBtn.addEventListener('click', stopCamera);

    // gallery button: trigger multiple file picker
    galleryBtn.addEventListener('click', () => galleryInput.click());
    galleryInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
        galleryInput.value = '';
    });

    // native camera capture (single photo via input) - also add as page
    cameraCapture.addEventListener('change', (e) => {
        if (e.target.files.length) handleFiles(e.target.files);
        cameraCapture.value = '';
    });

    // drag & drop zone
    uploadBox.addEventListener('click', () => galleryInput.click());
    uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); uploadBox.classList.add('highlight'); });
    uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('highlight'));
    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBox.classList.remove('highlight');
        handleFiles(e.dataTransfer.files);
    });

    // ----- PDF generation (ALL pages) -----
    pdfBtn.addEventListener('click', async () => {
        if (capturedPages.length === 0) {
            alert('No pages captured.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(); // start with first page

        for (let i = 0; i < capturedPages.length; i++) {
            const dataURL = capturedPages[i].dataURL;

            // if not first page, add a new page
            if (i > 0) doc.addPage();

            // get image dimensions (using a temporary image)
            const img = new Image();
            img.src = dataURL;
            await new Promise(r => { img.onload = r; }); // wait for load

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            const imgWidth = img.width;
            const imgHeight = img.height;

            const maxWidth = pageWidth - 20;
            const maxHeight = pageHeight - 20;
            const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);

            const drawWidth = imgWidth * ratio;
            const drawHeight = imgHeight * ratio;
            const xOffset = (pageWidth - drawWidth) / 2;
            const yOffset = (pageHeight - drawHeight) / 2;

            doc.addImage(dataURL, 'JPEG', xOffset, yOffset, drawWidth, drawHeight, undefined, 'FAST');
        }

        doc.save('multi-page-scan.pdf');
    });

    // ----- OCR on selected page -----
    ocrBtn.addEventListener('click', async () => {
        if (selectedIndex === -1 || !capturedPages[selectedIndex]) {
            alert('Select a page from the strip first.');
            return;
        }

        const dataURL = capturedPages[selectedIndex].dataURL;
        ocrResult.value = '‚è≥ OCR running ...';
        ocrBtn.disabled = true;

        try {
            const result = await Tesseract.recognize(dataURL, 'eng', {
                logger: m => console.log(m)
            });
            ocrResult.value = result.data.text.trim() || '(no text)';
        } catch (err) {
            ocrResult.value = '‚ùå OCR failed.';
        } finally {
            ocrBtn.disabled = false;
        }
    });

    // ----- remove last page -----
    removeBtn.addEventListener('click', () => {
        if (capturedPages.length > 0) {
            capturedPages.pop();
            if (selectedIndex >= capturedPages.length) {
                selectedIndex = capturedPages.length - 1;
            }
            renderStrip();
            if (capturedPages.length === 0) {
                preview.style.display = 'none';
                ocrResult.value = '';
            }
        }
    });

    // ----- clear all pages -----
    clearBtn.addEventListener('click', () => {
        capturedPages = [];
        selectedIndex = -1;
        renderStrip();
        preview.style.display = 'none';
        ocrResult.value = '';
        stopCamera();
    });

    // cleanup camera on page unload
    window.addEventListener('beforeunload', stopCamera);
})();
</script>
</body>
</html>
